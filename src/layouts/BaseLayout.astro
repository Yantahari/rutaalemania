---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SEO from '../components/SEO.astro';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  keywords?: string;
  ogImage?: string;
  ogType?: string;
  canonical?: string;
  noindex?: boolean;
  schema?: object;
}

const props = Astro.props;
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/favicon.ico" sizes="32x32" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="sitemap" href="/sitemap-index.xml" />
  <SEO {...props} />

  <!-- Google Consent Mode v2 (default: denied) + Analytics -->
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('consent', 'default', {
      analytics_storage: 'denied',
      ad_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied'
    });
    if (localStorage.getItem('cookie-consent') === 'accepted') {
      gtag('consent', 'update', { analytics_storage: 'granted' });
    }
  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MZJZDKPRBR"></script>
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-MZJZDKPRBR');
  </script>
</head>
<body class="min-h-screen flex flex-col">
  <Header />
  <main class="flex-1">
    <slot />
  </main>
  <Footer />

  <!-- Email popup (scroll-triggered) -->
  <div
    id="email-popup-overlay"
    data-email-popup
    class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4"
  >
    <div class="relative bg-coal border border-amber/20 rounded-2xl p-8 max-w-md w-full shadow-2xl" id="email-popup-box">
      <button
        type="button"
        id="email-popup-close"
        class="absolute top-4 right-4 text-white/30 hover:text-white text-xl leading-none"
        aria-label="Cerrar"
      >&times;</button>
      <div class="text-center">
        <div class="badge mb-4">PDF gratuito</div>
        <h3 class="font-heading text-xl mb-2">Checklist: 12 pasos para emigrar a Alemania</h3>
        <p class="text-white/50 text-sm mb-5">Descárgala gratis y ten todos los trámites claros antes de dar el salto.</p>
        <form
          class="flex flex-col gap-3 max-w-sm mx-auto"
          data-mailerlite-form
          onsubmit="event.preventDefault(); const e=this.querySelector('input[type=email]'); if(e.value){alert('¡Gracias! Te enviaremos la guía pronto.'); e.value=''; this.closest('[data-email-popup]')?.remove();}"
        >
          <input
            type="email"
            required
            placeholder="tu@email.com"
            class="w-full px-4 py-3 rounded-xl bg-white/[0.06] border border-white/10 text-white placeholder:text-white/30 focus:outline-none focus:border-amber/40 text-sm"
          />
          <button type="submit" class="btn-primary text-sm">Descargar checklist gratis</button>
        </form>
        <p class="text-white/25 text-xs mt-3">Sin spam. Te puedes dar de baja cuando quieras.</p>
      </div>
    </div>
  </div>

  <!-- Cookie consent banner (RGPD) -->
  <div
    id="cookie-banner"
    class="fixed bottom-0 left-0 right-0 z-[60] border-t border-amber/30 bg-coal/95 backdrop-blur-sm hidden"
    role="dialog"
    aria-label="Aviso de cookies"
  >
    <div class="container-narrow py-4 flex flex-col sm:flex-row items-start sm:items-center gap-4">
      <p class="text-white/70 text-sm flex-1">
        Usamos cookies de análisis (Google Analytics) para mejorar tu experiencia.
        <a href="/datenschutz/" class="text-amber-light hover:underline">Más información</a>.
      </p>
      <div class="flex gap-3 w-full sm:w-auto shrink-0">
        <button id="cookie-reject" class="px-4 py-2 rounded-xl text-sm text-white/50 border border-white/10 hover:border-white/30 hover:text-white/70 transition-colors cursor-pointer flex-1 sm:flex-initial">Rechazar</button>
        <button id="cookie-accept" class="btn-primary text-sm cursor-pointer flex-1 sm:flex-initial">Aceptar</button>
      </div>
    </div>
  </div>

  <script is:inline>
    (function() {
      var consent = localStorage.getItem('cookie-consent');
      var banner = document.getElementById('cookie-banner');
      if (!banner) return;

      if (!consent) {
        banner.classList.remove('hidden');
      }

      document.getElementById('cookie-accept').addEventListener('click', function() {
        localStorage.setItem('cookie-consent', 'accepted');
        gtag('consent', 'update', { analytics_storage: 'granted' });
        banner.classList.add('hidden');
      });

      document.getElementById('cookie-reject').addEventListener('click', function() {
        localStorage.setItem('cookie-consent', 'rejected');
        banner.classList.add('hidden');
      });
    })();
  </script>

  <script is:inline>
    (function() {
      if (sessionStorage.getItem('emailPopupShown')) return;

      var overlay = document.getElementById('email-popup-overlay');
      var box = document.getElementById('email-popup-box');
      var closeBtn = document.getElementById('email-popup-close');
      if (!overlay) return;

      var triggered = false;

      function showPopup() {
        if (triggered) return;
        triggered = true;
        sessionStorage.setItem('emailPopupShown', '1');
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
      }

      function hidePopup() {
        overlay.classList.add('hidden');
        overlay.classList.remove('flex');
      }

      window.addEventListener('scroll', function() {
        var scrollPercent = (window.scrollY + window.innerHeight) / document.documentElement.scrollHeight;
        if (scrollPercent >= 0.5) showPopup();
      });

      closeBtn.addEventListener('click', hidePopup);

      overlay.addEventListener('click', function(e) {
        if (!box.contains(e.target)) hidePopup();
      });
    })();
  </script>
</body>
</html>
